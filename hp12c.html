<script>
let mode = "pct";

function setMode(m){
  mode = m;
  btnPct.classList.toggle("active", m==="pct");
  btnDec.classList.toggle("active", m==="dec");
}

function num(v){
  return Number(String(v).replace(",", ".")) || 0;
}

function rate(){
  let r = num(i.value);
  return mode==="pct" ? r/100 : r;
}

function show(html){
  res.style.display="block";
  res.innerHTML = html;
}

/* ========= SOLVER ========= */

function calcular(){
  const PV = num(pv.value);
  const FV = num(fv.value);
  const PMT = num(pmt.value);
  let R = rate();
  let N = num(n.value);

  const filled = [
    pv.value !== "",
    fv.value !== "",
    pmt.value !== "",
    i.value !== "",
    n.value !== ""
  ].filter(Boolean).length;

  if(filled < 4){
    alert("Informe pelo menos 4 variÃ¡veis.");
    return;
  }

  /* CALCULAR FV */
  if(fv.value===""){
    const fvCalc = PV*Math.pow(1+R,N) + PMT*((Math.pow(1+R,N)-1)/R);
    show("ðŸ’° <strong>FV:</strong> R$ "+fvCalc.toFixed(2));
    return;
  }

  /* CALCULAR PV */
  if(pv.value===""){
    const pvCalc = (FV - PMT*((Math.pow(1+R,N)-1)/R)) / Math.pow(1+R,N);
    show("ðŸ’° <strong>PV:</strong> R$ "+pvCalc.toFixed(2));
    return;
  }

  /* CALCULAR PMT */
  if(pmt.value===""){
    const pmtCalc = (FV - PV*Math.pow(1+R,N)) * R / (Math.pow(1+R,N)-1);
    show("ðŸ’° <strong>PMT:</strong> R$ "+pmtCalc.toFixed(2));
    return;
  }

  /* CALCULAR N (iterativo) */
  if(n.value===""){
    let nCalc = 1;
    for(let k=0;k<1000;k++){
      let f = PV*Math.pow(1+R,nCalc) + PMT*((Math.pow(1+R,nCalc)-1)/R) - FV;
      let df = PV*Math.pow(1+R,nCalc)*Math.log(1+R)
             + PMT*Math.pow(1+R,nCalc)*Math.log(1+R)/R;
      nCalc = nCalc - f/df;
    }
    show("ðŸ“† <strong>PerÃ­odos (n):</strong> "+nCalc.toFixed(2));
    return;
  }

  /* CALCULAR i (TAXA â€“ iterativo) */
  if(i.value===""){
    let irr = 0.1;
    for(let k=0;k<2000;k++){
      let f = PV*Math.pow(1+irr,N) + PMT*((Math.pow(1+irr,N)-1)/irr) - FV;
      let df = PV*N*Math.pow(1+irr,N-1)
             + PMT*((irr*Math.pow(1+irr,N)- (Math.pow(1+irr,N)-1))/(irr*irr));
      irr = irr - f/df;
    }
    let taxa = mode==="pct" ? irr*100 : irr;
    show("ðŸ“ˆ <strong>Taxa (i):</strong> "+taxa.toFixed(4)+(mode==="pct"?"%":""));
    return;
  }

  alert("Deixe uma variÃ¡vel vazia para calcular.");
}
</script>
