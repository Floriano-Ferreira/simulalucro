<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>TIR, VPL, Payback e Montante | SimulaLucro</title>

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Calculadora financeira HP12c-like para TIR, VPL, Payback e Montante com fluxo de caixa.">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f3f6fb;
  color:#1f2937;
}
header{
  background:#fff;
  padding:14px 16px;
  box-shadow:0 2px 10px rgba(0,0,0,.08);
}
.container{
  max-width:960px;
  margin:auto;
  padding:24px 16px;
}
.card{
  background:#fff;
  padding:24px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
h1,h2{margin-top:0}
.fluxo-header, .fluxo-linha{
  display:grid;
  grid-template-columns:110px 120px 100px 36px;
  gap:8px;
  align-items:center;
}
.fluxo-header{
  font-weight:700;
  margin-bottom:6px;
}
.fluxo-linha input, .fluxo-linha select{
  padding:8px;
  border-radius:8px;
  border:1px solid #d1d5db;
}
.btn{
  background:#2563eb;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
}
.btn.small{padding:6px 10px;font-size:13px}
.btn.danger{background:#ef4444}
.result{
  margin-top:24px;
  background:#ecfeff;
  padding:20px;
  border-radius:12px;
}
.toggle{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:8px;
}
canvas{margin-top:30px;width:100%;max-width:100%}
@media(max-width:600px){
  .fluxo-header, .fluxo-linha{
    grid-template-columns:95px 90px 80px 32px;
  }
}
</style>
</head>

<body>

<header>
  <strong>üí∞ SimulaLucro</strong>
</header>

<main class="container">
<div class="card">

<h1>üìä TIR, VPL, Payback e Montante (HP12c-like)</h1>
<p>Insira o fluxo de caixa com data zero obrigat√≥ria.</p>

<h2>Fluxo de Caixa</h2>

<div class="fluxo-header">
  <div>Data</div>
  <div>Valor (R$)</div>
  <div>Tipo</div>
  <div></div>
</div>

<div id="fluxos"></div>

<button class="btn small" onclick="addLinha()">+ Adicionar linha</button>

<h2 style="margin-top:30px">Taxa de desconto</h2>

<input id="taxa" placeholder="Ex: 10" style="width:120px">
<div class="toggle">
  <label><input type="radio" name="modo" value="percentual" checked> %</label>
  <label><input type="radio" name="modo" value="decimal"> Decimal</label>
</div>

<button class="btn" style="margin-top:16px" onclick="calcular()">Calcular</button>

<div id="resultado" class="result"></div>

<canvas id="grafico" height="200"></canvas>

</div>
</main>

<script>
let fluxosDiv = document.getElementById("fluxos");

function addLinha(data="", valor="", tipo="Sa√≠da"){
  let row = document.createElement("div");
  row.className = "fluxo-linha";
  row.innerHTML = `
    <input type="date" value="${data}">
    <input type="number" placeholder="0" value="${valor}">
    <select>
      <option ${tipo==="Entrada"?"selected":""}>Entrada</option>
      <option ${tipo==="Sa√≠da"?"selected":""}>Sa√≠da</option>
    </select>
    <button class="btn danger small" onclick="this.parentNode.remove()">√ó</button>
  `;
  fluxosDiv.appendChild(row);
}

// linha inicial (Data Zero)
addLinha("", "", "Sa√≠da");

function calcular(){
  let rows = document.querySelectorAll(".fluxo-linha");
  if(rows.length < 2){
    alert("Informe pelo menos Data Zero + um fluxo.");
    return;
  }

  let datas = [];
  let valores = [];

  rows.forEach((r,i)=>{
    let d = new Date(r.children[0].value);
    let v = Number(r.children[1].value)||0;
    let t = r.children[2].value;
    if(i===0 && t!=="Sa√≠da"){
      alert("Data zero deve ser Sa√≠da (investimento inicial).");
      throw "";
    }
    if(t==="Sa√≠da") v = -Math.abs(v);
    datas.push(d);
    valores.push(v);
  });

  let taxa = Number(document.getElementById("taxa").value);
  let modo = document.querySelector("input[name='modo']:checked").value;
  if(modo==="percentual") taxa/=100;

  // ordena por data
  let base = datas[0];
  let fluxos = valores.map((v,i)=>{
    let dias = (datas[i]-base)/(1000*60*60*24);
    return {v:v, t:dias/30};
  });

  // VPL
  let vpl = fluxos.reduce((s,f)=>s + f.v/Math.pow(1+taxa,f.t),0);

  // FV
  let maxT = Math.max(...fluxos.map(f=>f.t));
  let fv = fluxos.reduce((s,f)=>s + f.v*Math.pow(1+taxa,maxT-f.t),0);

  // TIR (Newton-Raphson)
  function calcTIR(){
    let i=0.1;
    for(let k=0;k<1000;k++){
      let f=0, df=0;
      fluxos.forEach(fl=>{
        f+=fl.v/Math.pow(1+i,fl.t);
        df+=-fl.t*fl.v/Math.pow(1+i,fl.t+1);
      });
      let ni = i - f/df;
      if(Math.abs(ni-i)<1e-7) return ni;
      i=ni;
    }
    return null;
  }
  let tir = calcTIR();

  // Payback
  let acum=0, paySimple="N√£o recupera";
  for(let i=0;i<fluxos.length;i++){
    acum+=fluxos[i].v;
    if(acum>=0){paySimple=fluxos[i].t.toFixed(1)+" per√≠odos";break;}
  }

  let acumD=0, payDesc="N√£o recupera";
  for(let i=0;i<fluxos.length;i++){
    acumD+=fluxos[i].v/Math.pow(1+taxa,fluxos[i].t);
    if(acumD>=0){payDesc=fluxos[i].t.toFixed(1)+" per√≠odos";break;}
  }

  document.getElementById("resultado").innerHTML = `
    <strong>Resultados</strong><br><br>
    VPL: <strong>R$ ${vpl.toFixed(2)}</strong><br>
    FV: <strong>R$ ${fv.toFixed(2)}</strong><br>
    TIR: <strong>${tir? (tir*100).toFixed(2)+"%":"N√£o calcul√°vel"}</strong><br>
    Payback simples: <strong>${paySimple}</strong><br>
    Payback descontado: <strong>${payDesc}</strong>
  `;

  desenharGrafico(fluxos);
}

function desenharGrafico(fluxos){
  let c = document.getElementById("grafico");
  let ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  let max = Math.max(...fluxos.map(f=>Math.abs(f.v))) * 1.2;
  let w = c.width/fluxos.length;

  let acum=0;
  fluxos.forEach((f,i)=>{
    let h = (f.v/max)*(c.height/2);
    ctx.fillStyle = f.v>=0?"#22c55e":"#ef4444";
    ctx.fillRect(i*w, c.height/2-h, w*0.6, h);

    acum+=f.v;
    let y = c.height/2 - (acum/max)*(c.height/2);
    ctx.fillStyle="#2563eb";
    ctx.beginPath();
    ctx.arc(i*w+w*0.3,y,4,0,Math.PI*2);
    ctx.fill();
  });
}
</script>

</body>
</html>
